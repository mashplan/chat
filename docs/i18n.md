### Overview

This app uses next-intl for internationalization (i18n) with Swedish as the default language and support for English. The setup prioritizes:

- **simple config via env vars** (default locale, supported locales, time zone)
- **cookie-based locale persistence** (no locale subpaths yet)
- **SSR-safe time zone configuration** to avoid mismatches

Future-friendly: We can switch to locale subpaths (`/[locale]/...`) later for SEO and SSR-by-locale.

### Stack and versions

- **Library**: next-intl v4
- **Next.js**: App Router

### Files and structure

- `lib/i18n/config.ts`
  - `locales`: Supported locales from `LOCALES` env (default: `sv,en`)
  - `defaultLocale`: Default locale from `DEFAULT_LOCALE` env (default: `sv`)
  - `localePrefix`: `'as-needed'` (no subpaths for default locale)
  - `localeDetection`: `true`
  - `defaultTimeZone`: From `DEFAULT_TIME_ZONE` env (default: `Europe/Stockholm`)

- `lib/i18n/index.ts`
  - `LOCALE_COOKIE = 'NEXT_LOCALE'`
  - `getPreferredLocale()`: Reads the `cookie` header to retrieve `NEXT_LOCALE`, falls back to `Accept-Language`, then to `defaultLocale`
  - `getRequestConfig`: Provides `messages`, `locale`, and `timeZone` for next-intl

- `components/locale-provider.tsx`
  - Client provider that wraps the tree with `NextIntlClientProvider`
  - Applies `locale`, `messages`, and `timeZone`

- `app/layout.tsx`
  - Uses `defaultLocale` for SSR and loads `messages/<locale>.json`
  - Wraps children with `LocaleProvider`

- `middleware.ts`
  - Ensures the `NEXT_LOCALE` cookie is set based on `Accept-Language` when missing
  - Preserves existing auth logic

- `messages/`
  - `messages/sv.json`
  - `messages/en.json`
  - Start flat; adopt namespaces as the catalog grows

### Environment variables

Add to `.env` or hosting provider:

```bash
DEFAULT_LOCALE=sv
LOCALES=sv,en
DEFAULT_TIME_ZONE=Europe/Stockholm
```

### Default locale and URL strategy

- Default locale is Swedish (`sv`)
- No locale subpaths right now (URLs remain `/...`). SSR uses the default locale
- Middleware stores user preference in `NEXT_LOCALE` cookie for hydration and future use

If you want SSR in a non-default locale (e.g., English), consider moving to locale subpaths. See “Future: Locale subpaths”.

### Time zone

We set a global default time zone to avoid `ENVIRONMENT_FALLBACK` warnings:

- `defaultTimeZone` provided in both request config and client provider
- Defaults to `Europe/Stockholm`; override via `DEFAULT_TIME_ZONE`

### Using translations

- Client components (hooks):

```tsx
import {useTranslations} from 'next-intl';

export function UserProfile({user}: {user: {firstName: string; memberSince: string; numFollowers: number}}) {
  const t = useTranslations('UserProfile');
  return (
    <section>
      <h1>{t('title', {firstName: user.firstName})}</h1>
      <p>{t('membership', {memberSince: user.memberSince})}</p>
      <p>{t('followers', {count: user.numFollowers})}</p>
    </section>
  );
}
```

- Server components (helpers):

```tsx
import {getTranslations} from 'next-intl/server';

export default async function Example() {
  const t = await getTranslations('App');
  return <h1>{t('title')}</h1>;
}
```

### Keys and namespacing

- Prefer descriptive, dot-delimited keys: `auth.login.title`, `chat.input.placeholder`
- Start with flat files (`en.json`, `sv.json`); when large, split by namespace:
  - `messages/sv/auth.json`, `messages/sv/chat.json`, etc.
- Keep interpolation variables consistent across locales

### Adding a new language

1. Add the locale to `LOCALES` (e.g., `sv,en,de`)
2. Create `messages/<locale>.json`
3. Translate keys incrementally; missing keys fall back to the default language during development

### Language switching

- With today’s setup (no subpaths): implement a simple switcher that sets `NEXT_LOCALE` and reloads
  - SSR will still render the default locale; client hydration will pick up the selected locale content
- For full SSR in the selected locale and SEO, move to locale subpaths

### SEO

- Current: URLs aren’t locale-specific; no `hreflang` yet
- With subpaths: add `hreflang`, canonical links, and localized metadata

### Testing tips

- E2E (Playwright): set `Accept-Language` and ensure cookie behavior
- Test that `NEXT_LOCALE` persists and that strings render correctly in both `sv` and `en`

### Common pitfalls and fixes

- **Dynamic APIs in layouts**: Avoid calling `cookies()`/`headers()` synchronously in root layout; we read the `cookie` header instead
- **Time zone warnings**: Ensure `defaultTimeZone` is set in both server config and client provider

### References

- next-intl docs: [Configuration](https://next-intl.dev/docs/configuration), [Usage](https://next-intl.dev/docs/getting-started/app-router)

### Future: Locale subpaths

- Switch to routes like `/sv/...` and `/en/...` with default hidden (`/` → `sv`)
- Benefits: SSR in selected locale, shareable links, SEO (`hreflang`)
- Requires: route segment for `[locale]`, link helpers, and small middleware changes


